# 自動リトライ機能の実装

## タスク1: リトライ設定の追加

cmd/sync.go に以下のリトライ設定を追加してください:

### 実装内容
- `maxRetries` 変数をグローバル変数に追加（デフォルト: 3回）
- `--max-retries` フラグを追加して、ユーザーが最大リトライ回数を指定できるようにする
- リトライ回数のカウンター変数を追加

### 確認
- `go build -o bin/sleepship`

---

## タスク2: タスク実行の自動リトライ機能

cmd/sync.go の `runSync` 関数内のタスク実行部分を修正してください:

### 実装内容
現在の実装（170-172行付近）:
```go
if err := executeTask(task, f); err != nil {
    log.Printf("❌ Task %d failed: %v\n", taskNum, err)
    log.Printf("Stopping execution.\n")
    return fmt.Errorf("task %d failed: %w", taskNum, err)
}
```

これを以下のように変更:
- タスク実行が失敗した場合、自動的に最大maxRetries回までリトライする
- 各リトライごとに「タスクXの実行に失敗しました。リトライY/Z回目を実行します」とログ出力
- リトライ時は前回のエラー内容を含めたプロンプトでClaudeに再実行させる
- maxRetries回試してもすべて失敗した場合のみ、停止する

### 確認
- `go build -o bin/sleepship`

---

## タスク3: 検証失敗時の自動リトライ機能強化

cmd/sync.go の検証失敗部分（178-193行付近）を改善してください:

### 実装内容
現在は1回だけ修正を試みていますが、これをmaxRetries回まで繰り返すように変更:
- 検証コマンドが失敗したら、修正を試みる
- 修正後に検証を再実行
- これをmaxRetries回まで繰り返す
- 各リトライで「検証失敗、修正を試みます（リトライY/Z回目）」とログ出力
- maxRetries回試してもすべて失敗した場合のみ、停止する

### 確認
- `go build -o bin/sleepship`

---

## タスク4: README.mdの更新

README.md に新しい `--max-retries` オプションのドキュメントを追加してください:

### 実装内容
- クイックスタートセクションに `--max-retries` の使用例を追加
- 使用例セクションに詳細な説明を追加
- デフォルト値は3回であることを明記
- 0を指定すると無限リトライになることを説明（もし実装する場合）

### 確認
- `cat README.md`

---

## タスク5: テスト用タスクファイルの作成

実装した自動リトライ機能をテストするためのサンプルタスクファイルを作成してください:

### 実装内容
`tasks-retry-test.txt` を作成:
- わざと失敗しやすいタスクを含める（存在しないファイルの編集など）
- リトライ機能が正しく動作することを確認できる内容にする

### 確認
- `cat tasks-retry-test.txt`
