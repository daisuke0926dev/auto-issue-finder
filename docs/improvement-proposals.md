# Sleepship 改善提案

## 概要

本ドキュメントは、主要CLIツール（GitHub CLI, Cargo, npm/yarn, Docker, kubectl）の設計パターン調査結果を基に、sleepshipに適用できる改善点をまとめたものです。

---

## 現在のsleepshipの課題

### 1. タスクファイル指定の制約

**現状:**
- タスクファイルはコマンド引数で絶対パス or 相対パスを指定する必要がある
- タスクファイルの命名規則が固定されていない（`tasks-*.txt` を推奨しているが強制ではない）
- カレントディレクトリからタスクファイルを探索する機能がない

**問題点:**
- 毎回フルパスを入力する必要があり、タイピング量が多い
- デフォルトのタスクファイル（例: `tasks.txt`）を暗黙的に実行できない
- タスクファイルの管理が属人的になりやすい

### 2. プロジェクトディレクトリの扱い

**現状:**
- `--dir` フラグでプロジェクトディレクトリを指定可能
- 未指定時はカレントディレクトリを使用
- プロジェクトルートの自動検出機能がない

**問題点:**
- ネストされたディレクトリからsleepshipを実行する際、常に `--dir` でルートを指定する必要がある
- `.sleepship.toml` や `.git` などのマーカーファイルからプロジェクトルートを推論できない

### 3. 設定ファイルの欠如

**現状:**
- すべての設定をコマンドラインフラグまたは環境変数で指定
- 設定の永続化機能がない
- プロジェクト固有の設定を保存できない

**問題点:**
- 毎回同じフラグを指定する必要がある（例: `--max-retries 5`）
- 複数プロジェクトで異なる設定を管理しにくい
- チーム内で設定を共有できない

### 4. タスクファイル管理

**現状:**
- タスクファイルは `.gitignore` で除外されている
- タスクファイルの履歴管理がない
- 実行済みタスクと未実行タスクの区別がない

**問題点:**
- 過去にどんなタスクを実行したか追跡できない
- タスクファイルをGit管理するとコミットログが汚れる可能性
- タスクの実行履歴を確認する手段がない

### 5. ワークスペース/モノレポ非対応

**現状:**
- 単一プロジェクト向けの設計
- 複数プロジェクトを横断したタスク実行ができない
- ワークスペース管理機能がない

**問題点:**
- モノレポ構成のプロジェクトで使いにくい
- 複数の関連プロジェクトを一括で自動化できない

### 6. エイリアス/ショートハンド機能の欠如

**現状:**
- すべてのコマンドを完全な形式で入力する必要がある
- タスクファイル名を省略できない
- よく使うコマンドのショートカットがない

**問題点:**
- タイピング量が多い
- 頻繁に使う操作が煩雑

### 7. コンテキスト管理の欠如

**現状:**
- プロジェクト間の切り替えが手動
- デフォルトプロジェクトの概念がない

**問題点:**
- 複数プロジェクトで作業する際に非効率
- プロジェクト設定を都度指定する必要がある

---

## 調査結果から学べること

### 1. 自動検出とデフォルト値の活用

**Cargoの例:**
- カレントディレクトリから親ディレクトリへ再帰的に `Cargo.toml` を探索
- 最初に見つかったファイルをプロジェクトルートとして使用

**npm/yarnの例:**
- `package.json` を再帰的に探索
- ネストされたディレクトリからでも自動でプロジェクトルートを検出

**sleepshipへの適用:**
- `.sleepship.toml` をプロジェクトマーカーとして使用
- カレントディレクトリから親ディレクトリへ再帰的に探索
- デフォルトタスクファイル（例: `tasks.txt`）を自動検出

### 2. 階層的な設定管理

**優先順位パターン（共通）:**
1. コマンドラインフラグ（最優先）
2. 環境変数
3. プロジェクトローカル設定ファイル
4. ユーザーグローバル設定ファイル
5. システムグローバル設定
6. 組み込みデフォルト値（最低優先）

**Cargoの例:**
```bash
# 環境変数による設定オーバーライド
export CARGO_BUILD_JOBS=4

# プロジェクト固有の設定
.cargo/config.toml

# グローバル設定
$CARGO_HOME/config.toml
```

**sleepshipへの適用:**
```bash
# 環境変数
export SLEEPSHIP_MAX_RETRIES=5
export SLEEPSHIP_LOG_DIR=logs

# プロジェクト設定
.sleepship.toml

# グローバル設定
~/.config/sleepship/config.toml
```

### 3. ショートハンドとエイリアス

**GitHub CLIの例:**
- `OWNER/REPO` 形式で指定
- 自分のリポジトリの場合、`OWNER/` を省略可能
- `gh repo view` で引数なしの場合、現在のディレクトリのリポジトリを表示

**kubectlの例:**
- `pods` → `po`
- `deployments` → `deploy`
- `services` → `svc`

**sleepshipへの適用:**
- `sleepship sync` で引数なしの場合、デフォルトタスクファイルを実行
- `sleepship sync 1` でタスク番号から開始（`--start-from 1` の短縮形）
- タスクファイル名のプレフィックス省略（`tasks-` を自動補完）

### 4. ワークスペース/モノレポ対応

**Cargoのワークスペース:**
```toml
[workspace]
members = [
    "crate-a",
    "crate-b",
    "tools/cli"
]
```

**npmワークスペース:**
```json
{
  "workspaces": [
    "packages/*",
    "tools/cli"
  ]
}
```

**sleepshipへの適用:**
```toml
# .sleepship.toml
[workspace]
members = [
    "services/api",
    "services/web",
    "packages/shared"
]

# 各メンバーで個別に実行
[workspace.services/api]
default_task_file = "tasks.txt"
max_retries = 5
```

### 5. コンテキスト管理

**kubectlの例:**
```bash
# コンテキスト切り替え
kubectl config use-context prod-context

# デフォルト設定
kubectl config set-context --current --namespace=my-namespace
```

**GitHub CLIの例:**
```bash
# デフォルトリポジトリ設定
gh repo set-default

# 確認
gh repo set-default --view
```

**sleepshipへの適用:**
```bash
# プロジェクトコンテキスト設定
sleepship config set-default --project=my-project

# 確認
sleepship config get-default

# コマンド単位でオーバーライド
sleepship sync --project=other-project
```

### 6. 環境変数の命名規則

**共通パターン:**
- プレフィックス統一: `GH_*`, `CARGO_*`, `NPM_CONFIG_*`, `DOCKER_*`
- 階層的な命名: `CARGO_BUILD_JOBS` (`build.jobs` に対応)
- 大文字+アンダースコア

**sleepshipへの適用:**
```bash
# プロジェクト設定
export SLEEPSHIP_PROJECT_DIR=/path/to/project
export SLEEPSHIP_TASK_FILE=tasks.txt

# 実行設定
export SLEEPSHIP_MAX_RETRIES=5
export SLEEPSHIP_LOG_DIR=logs
export SLEEPSHIP_START_FROM=6

# ワークスペース設定
export SLEEPSHIP_WORKSPACE_MEMBER=services/api
```

---

## 優先度付き改善提案リスト

### P0 (緊急・必須)

#### P0-1: 設定ファイルサポート

**概要:**
`.sleepship.toml` による設定管理機能を追加

**実装内容:**
- プロジェクトルートに `.sleepship.toml` を配置
- ユーザーグローバル設定: `~/.config/sleepship/config.toml`
- 設定の階層的マージ（CLI > 環境変数 > プロジェクト > グローバル > デフォルト）

**設定例:**
```toml
# .sleepship.toml
[project]
name = "my-project"
dir = "."

[sync]
default_task_file = "tasks.txt"
max_retries = 3
log_dir = "logs"
start_from = 1

[claude]
flags = ["--dangerously-skip-permissions"]
```

**実装難易度:** 中
**影響範囲:** cmd/root.go, cmd/sync.go（新規: internal/config/）
**期待効果:**
- 設定の永続化
- チーム内での設定共有
- タイピング量の削減

#### P0-2: プロジェクトルートの自動検出

**概要:**
`.sleepship.toml` または `.git` からプロジェクトルートを自動検出

**実装内容:**
- カレントディレクトリから親ディレクトリへ再帰的に `.sleepship.toml` を探索
- `.sleepship.toml` がない場合、`.git` ディレクトリを探索
- 見つかった場所をプロジェクトルートとして使用

**実装難易度:** 低
**影響範囲:** cmd/sync.go（新規: internal/project/）
**期待効果:**
- ネストされたディレクトリからの実行が可能
- `--dir` フラグの指定が不要に

#### P0-3: デフォルトタスクファイルの自動検出

**概要:**
タスクファイル引数が省略された場合、デフォルトタスクファイルを使用

**実装内容:**
- 引数省略時に `tasks.txt` を探索
- 設定ファイルで `default_task_file` をカスタマイズ可能
- タスクファイルが見つからない場合、エラーメッセージで候補を表示

**実装難易度:** 低
**影響範囲:** cmd/sync.go
**期待効果:**
- タイピング量の削減（`sleepship sync` だけで実行可能）
- ユーザビリティの向上

### P1 (重要・推奨)

#### P1-1: 環境変数による設定オーバーライド

**概要:**
`SLEEPSHIP_*` 環境変数で設定をオーバーライド

**実装内容:**
- 命名規則: `SLEEPSHIP_<SECTION>_<KEY>`
- 例: `SLEEPSHIP_SYNC_MAX_RETRIES=5`
- 環境変数は設定ファイルより優先（CLIフラグより低）

**実装難易度:** 中
**影響範囲:** internal/config/
**期待効果:**
- CI/CD環境での柔軟な設定
- スクリプトでの動的な設定変更

#### P1-2: タスクファイル名の補完

**概要:**
タスクファイル名の `tasks-` プレフィックスを自動補完

**実装内容:**
- `sleepship sync feature` → `tasks-feature.txt` を探索
- `sleepship sync feature.txt` → `tasks-feature.txt` を探索
- フォールバック: 指定されたファイル名そのまま

**実装難易度:** 低
**影響範囲:** cmd/sync.go
**期待効果:**
- タイピング量の削減
- タスクファイルの命名規則の統一

#### P1-3: タスク実行履歴の記録

**概要:**
実行したタスクの履歴を `.sleepship/history.json` に記録

**実装内容:**
- タスクファイル名、実行日時、成功/失敗、実行時間を記録
- `sleepship history` コマンドで履歴表示
- `sleepship history --last` で最後に実行したタスクを表示

**実装難易度:** 中
**影響範囲:** cmd/sync.go（新規: cmd/history.go, internal/history/）
**期待効果:**
- タスクの実行履歴を追跡
- トラブルシューティングの効率化

#### P1-4: エイリアス機能

**概要:**
よく使うコマンドをエイリアスとして設定

**実装内容:**
```toml
# .sleepship.toml
[aliases]
dev = "sync tasks-dev.txt"
test = "sync tasks-test.txt --max-retries=5"
prod = "sync tasks-prod.txt --max-retries=10"
```

**実装難易度:** 中
**影響範囲:** cmd/root.go（エイリアス解決ロジック）
**期待効果:**
- タイピング量の大幅削減
- よく使うコマンドの簡略化

#### P1-5: 進捗表示の改善

**概要:**
リアルタイムで進捗をターミナルに表示

**実装内容:**
- 現在のタスク番号と進捗率を表示
- 各タスクの実行時間を表示
- プログレスバーまたはスピナーの表示

**実装難易度:** 中
**影響範囲:** cmd/sync.go
**期待効果:**
- ユーザビリティの向上
- 実行状況の可視化

### P2 (改善・長期的)

#### P2-1: ワークスペース/モノレポサポート

**概要:**
複数プロジェクトを統合管理

**実装内容:**
```toml
# .sleepship.toml
[workspace]
members = [
    "services/api",
    "services/web",
    "packages/shared"
]

# メンバー固有の設定
[workspace.services/api]
default_task_file = "tasks-api.txt"

[workspace.services/web]
default_task_file = "tasks-web.txt"
```

**実行例:**
```bash
# 特定のメンバーで実行
sleepship sync --workspace=services/api

# すべてのメンバーで実行
sleepship sync --all-workspaces
```

**実装難易度:** 高
**影響範囲:** 全体的な設計変更が必要
**期待効果:**
- モノレポ構成のプロジェクトでの利用
- 複数プロジェクトの一括管理

#### P2-2: コンテキスト管理

**概要:**
複数プロジェクト間の切り替えを簡単に

**実装内容:**
```bash
# コンテキスト登録
sleepship context set my-project --dir=/path/to/project

# コンテキスト切り替え
sleepship context use my-project

# デフォルトコンテキスト設定
sleepship context set-default my-project

# 現在のコンテキスト確認
sleepship context current
```

**実装難易度:** 高
**影響範囲:** 新規サブコマンド追加、グローバル設定管理
**期待効果:**
- 複数プロジェクト間の切り替えが容易
- プロジェクト固有の設定を保持

#### P2-3: タスクテンプレート機能

**概要:**
よく使うタスクパターンをテンプレート化

**実装内容:**
```bash
# テンプレート登録
sleepship template add go-feature tasks-go-feature.txt

# テンプレートからタスクファイル生成
sleepship init --template=go-feature

# テンプレート一覧
sleepship template list
```

**実装難易度:** 中
**影響範囲:** 新規サブコマンド追加、テンプレート管理
**期待効果:**
- タスクファイル作成の効率化
- チーム内でのタスクパターン共有

#### P2-4: ドライラン機能

**概要:**
実行前にタスクの内容を確認

**実装内容:**
```bash
# ドライランモード
sleepship sync --dry-run

# 出力例
# Task 1/5: ユーザーモデルの実装
# Description: models/user.go にUserモデルを実装
# Verification: go build
#
# Task 2/5: テストの追加
# ...
```

**実装難易度:** 低
**影響範囲:** cmd/sync.go
**期待効果:**
- 実行前の確認
- タスクファイルの妥当性検証

#### P2-5: タスクファイルのバリデーション

**概要:**
タスクファイルの構文チェック

**実装内容:**
```bash
# バリデーション実行
sleepship validate tasks.txt

# チェック項目:
# - タスク番号の連番チェック
# - 必須フィールドの存在確認
# - 確認コマンドの妥当性チェック
# - Markdown構文の検証
```

**実装難易度:** 中
**影響範囲:** 新規サブコマンド追加、パーサー改善
**期待効果:**
- タスクファイルの品質向上
- 実行前のエラー検出

#### P2-6: インタラクティブモード

**概要:**
対話的にタスクを選択・実行

**実装内容:**
```bash
sleepship sync --interactive

# 対話的UI:
# ? Which tasks do you want to run? (Space to select, Enter to confirm)
#   [x] Task 1: ユーザーモデルの実装
#   [ ] Task 2: テストの追加
#   [x] Task 3: APIエンドポイント実装
#   [ ] Task 4: ドキュメント更新
```

**実装難易度:** 高
**影響範囲:** cmd/sync.go（TUIライブラリの導入）
**期待効果:**
- ユーザビリティの向上
- 柔軟なタスク選択

#### P2-7: プラグインシステム

**概要:**
カスタム機能を拡張可能に

**実装内容:**
- プラグインAPI定義
- プラグイン検索パス（`.sleepship/plugins/`, `~/.config/sleepship/plugins/`）
- プラグインマネージャー

**実装難易度:** 非常に高
**影響範囲:** 全体的なアーキテクチャ変更
**期待効果:**
- コミュニティによる拡張
- カスタマイズ性の向上

---

## 実装ロードマップ

### フェーズ1: 基本UX改善（1-2週間）

**目標:** 日常的な使い勝手の向上

**実装内容:**
- P0-1: 設定ファイルサポート
- P0-2: プロジェクトルートの自動検出
- P0-3: デフォルトタスクファイルの自動検出
- P1-2: タスクファイル名の補完

**期待効果:**
- `sleepship sync` だけで実行可能
- 設定の永続化
- ネストされたディレクトリからの実行

### フェーズ2: 設定管理強化（1週間）

**目標:** 柔軟な設定管理

**実装内容:**
- P1-1: 環境変数による設定オーバーライド
- P1-4: エイリアス機能
- P1-3: タスク実行履歴の記録

**期待効果:**
- CI/CD環境での利用改善
- タイピング量の削減
- 実行履歴の追跡

### フェーズ3: 進捗可視化（1週間）

**目標:** 実行状況の可視化

**実装内容:**
- P1-5: 進捗表示の改善
- P2-4: ドライラン機能
- P2-5: タスクファイルのバリデーション

**期待効果:**
- ユーザビリティの向上
- 実行前の確認
- タスクファイルの品質向上

### フェーズ4: 高度な機能（2-4週間）

**目標:** エンタープライズ対応

**実装内容:**
- P2-1: ワークスペース/モノレポサポート
- P2-2: コンテキスト管理
- P2-3: タスクテンプレート機能

**期待効果:**
- モノレポ構成での利用
- 複数プロジェクトの管理
- タスク作成の効率化

### フェーズ5: 拡張性向上（長期）

**目標:** カスタマイズ性とコミュニティ対応

**実装内容:**
- P2-6: インタラクティブモード
- P2-7: プラグインシステム

**期待効果:**
- ユーザーによる拡張
- コミュニティの活性化

---

## 次のフェーズで実装すべき機能

### 即座に実装すべき（Next Sprint）

1. **P0-1: 設定ファイルサポート**
   - 最も影響範囲が大きく、他の機能の基盤となる
   - 実装難易度は中程度だが、長期的な価値が高い

2. **P0-2: プロジェクトルートの自動検出**
   - 実装難易度が低く、すぐに効果が出る
   - ユーザビリティの大幅な向上

3. **P0-3: デフォルトタスクファイルの自動検出**
   - 実装難易度が低く、すぐに効果が出る
   - タイピング量の削減

### 中期的に実装すべき（Next Quarter）

1. **P1-1: 環境変数による設定オーバーライド**
   - CI/CD環境での利用に必須
   - P0-1の設定ファイル実装後に追加

2. **P1-3: タスク実行履歴の記録**
   - トラブルシューティングに有用
   - デバッグ効率の向上

3. **P1-4: エイリアス機能**
   - ユーザビリティの大幅向上
   - P0-1の設定ファイル実装後に追加

### 長期的に検討すべき（Future）

1. **P2-1: ワークスペース/モノレポサポート**
   - 大規模プロジェクトでの需要
   - 設計の大幅な変更が必要

2. **P2-2: コンテキスト管理**
   - 複数プロジェクトでの作業効率向上
   - グローバル設定管理の実装が必要

3. **P2-7: プラグインシステム**
   - コミュニティによる拡張
   - アーキテクチャの大幅な変更が必要

---

## まとめ

### 主要な学び

1. **自動検出とデフォルト値の活用**
   - ユーザーの手間を最小化
   - 合理的なデフォルト値を提供

2. **階層的な設定管理**
   - 柔軟性と使いやすさのバランス
   - CLI > 環境変数 > プロジェクト > グローバル > デフォルト

3. **ショートハンドとエイリアス**
   - タイピング量の削減
   - よく使うパターンの簡略化

4. **ワークスペース/モノレポ対応**
   - 大規模プロジェクトでのスケーラビリティ
   - 関連プロジェクトの統合管理

5. **コンテキスト管理**
   - 複数プロジェクト間の切り替え
   - プロジェクト固有の設定保持

### 優先的に実装すべき機能

**フェーズ1（即座に実装）:**
- 設定ファイルサポート
- プロジェクトルート自動検出
- デフォルトタスクファイル自動検出

これらの機能により、sleepshipの使いやすさが大幅に向上し、日常的な開発作業での採用が促進されます。

**次のステップ:**
1. フェーズ1の機能詳細設計
2. 設定ファイルフォーマットの決定（TOML vs YAML vs JSON）
3. 実装タスクの分解と優先順位付け
4. プロトタイプ実装とユーザーフィードバック収集
